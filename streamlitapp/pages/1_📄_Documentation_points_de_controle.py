import streamlit as st
from streamlit_modal import Modal
import os
import re
import json
import pandas as pd
import numpy as np
from openai import AzureOpenAI

st.set_page_config(page_title="V√©Ga - Documentation points de contr√¥le", page_icon="üìÑ")

walk = [dir for dir in os.walk('pdc_content')]
cats = []
for dir in walk[0][1]:
    with open(f'pdc_content/{dir}/info.json') as f:
        d = json.load(f)
        cats.append(d)


def parse_object_to_md(obj):
    md = """"""
    md += f"# Point de contr√¥le\n{obj['name']}\n\n\n"
    md += f"## Cat√©gorie\n {obj['category_name']}\n\n"
    md += f"## Description\n{obj['desc']}\n\n"
    
    base_leg = """"""
    for leg in obj['base_leg']:
      base_leg += f"- {leg}\n"
    md += f"## Base l√©gale\n{base_leg}\n\n"

    methodology = """"""
    for i, meth in enumerate(obj['methodology']):
      methodology += f"{i}. {meth}\n"
    md += f"## M√©thodologie\n{methodology}\n\n"

    md += f"## Exemple de conformit√©\n{obj['conform_example']}\n\n"
    md += f"## Exemple de non-conformit√©\n{obj['non_conform_example']}\n\n"
    md += f"## Proc√©dure\n{obj['proc']}"
    return md


def generate_embeddings(text, model="ada-002"):
    return st.session_state["client"].embeddings.create(input = [text], model=model).data[0].embedding


def normalize_text(s, sep_token = " \n "):
    s = re.sub(r'\s+',  ' ', s).strip()
    s = re.sub(r". ,","",s)
    # remove all instances of multiple spaces
    s = s.replace("..",".")
    s = s.replace(". .",".")
    s = s.replace("\n", "")
    s = s.strip()
    
    return s


def addcp():
    import streamlit as st
    st.sidebar.image("vega.png")

    cat = st.session_state['state-doccp-cat-ct']
    st.write(f"# ‚ûï Ajout d'un point de contr√¥le √† la cat√©gorie {cat['name']}")

    retour = st.columns((3,1))[1].button("üîô Retour", type="secondary", use_container_width=True)
    if retour:
        st.session_state['state-doccp'] = "enum"
        st.rerun()

    st.write("#### G√©n√©ral")

    st.text_input("Cat√©gorie", value=cat['name'], disabled=True)

    code = st.text_input("Code", placeholder="dispo",
            help="Code court, sans accents, chiffres ou caract√®res sp√©ciaux, par exemple \"dispo\" ")

    name = st.text_input("Nom du point de contr√¥le", placeholder="Disponibilit√©",
            help="Nom court mais complet, par exemple \"Disponibilit√©\" ")

    desc = st.text_area("Description", placeholder="L‚ÄôAPI doit √™tre tout le temps disponible.",
            help="Description d√©taill√©e")

    st.write("#### Base l√©gale")
    st.markdown("Listes des r√©f√©rences qui servent de base l√©gale au point de contr√¥le, s√©par√©e par des virgules.")
    st.markdown("_Double cliquer sur une ligne pour l'√©diter._")

    base_leg = st.data_editor(pd.DataFrame(["Premier article..."], columns=["Etape"]), key="baseleg", use_container_width=True,
     hide_index=True, num_rows="dynamic")

    st.write("#### M√©thodologie")
    st.markdown("Etapes √† suivre par le programme pour d√©terminer la conformit√© √† ce point de contr√¥le.")
    st.markdown("_Double cliquer sur une ligne pour l'√©diter._")
    methodo = st.data_editor(pd.DataFrame(["Premi√®re √©tape..."], columns=["Etape"]), key="methodo", use_container_width=True,
     hide_index=True, num_rows="dynamic")

    st.write("#### Exemples")
    
    exconf = st.text_area("Exemple de conformit√©", placeholder="D√©tail d'un exemple de conformit√© au point de contr√¥le",
            help="Donnez ici le d√©tail d'un exemple de conformit√© au point de contr√¥le")

    exnonconf = st.text_area("Exemple de non conformit√©", placeholder="D√©tail d'un exemple de non conformit√© au point de contr√¥le",
            help="Donnez ici le d√©tail d'un exemple de non conformit√© au point de contr√¥le")

    st.write("#### Proc√©dure")

    proc = st.text_area("Proc√©dure √† suivre en cas de non-conformit√©", placeholder="Il faut prendre contact avec l‚Äô√©tablissement pour comprendre l‚Äôorigine de l‚Äôindisponibilit√©.",
            help="Proc√©dure √† suivre en cas de non-conformit√©")

    st.markdown('##')
    save = st.button("‚ú® Cr√©er", type="primary", use_container_width=True)

    if save:
        data = {
            "category_name": cat["name"],
            "name": name,
            "code": code,
            "desc": desc,
            "base_leg": base_leg.values.ravel().tolist(),
            "methodology": methodo.values.ravel().tolist(),
            "conform_example": exconf,
            "non_conform_example": exnonconf,
            "proc": proc
        }
        with open(f'pdc_content/{cat["code"]}/{code}.json', 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=4)

        st.session_state['state-doccp'] = "enum"
        st.rerun()

def editcp():
    import streamlit as st
    st.sidebar.image("vega.png")

    cat = st.session_state['state-doccp-cat-ct']
    fname = st.session_state['state-doccp-fname']

    data = None
    with open(f'pdc_content/{cat["code"]}/{fname}.json') as f:
        data = json.load(f)

    while data == None:
        st.write("chargement...")
    
    st.write(f"# ‚úèÔ∏è Edition du point de contr√¥le {data['name']}")
        
    colps = st.columns((1,1,2))
    delete = colps[1].button("‚ö†Ô∏è Supprimer", type="primary", use_container_width=True)
    retour = colps[2].button("üîô Retour", type="secondary", use_container_width=True)
    if retour:
        st.session_state['state-doccp'] = "enum"
        st.rerun()
    if delete:
        os.remove(f'pdc_content/{cat["code"]}/{fname}.json')
        st.session_state['state-doccp'] = "enum"
        st.rerun()

    st.write("#### G√©n√©ral")

    st.text_input("Cat√©gorie", value=cat['name'], disabled=True)

    code = st.text_input("Code", value=data['code'], disabled=True)

    name = st.text_input("Nom du point de contr√¥le", value=data["name"],
            help="Nom court mais complet, par exemple \"Disponibilit√©\" ")

    desc = st.text_area("Description", value=data["desc"],
            help="Description d√©taill√©e")

    st.write("#### Base l√©gale")
    st.markdown("Listes des r√©f√©rences qui servent de base l√©gale au point de contr√¥le, s√©par√©e par des virgules.")
    st.markdown("_Double cliquer sur une ligne pour l'√©diter._")

    base_leg = st.data_editor(pd.DataFrame(data["base_leg"], columns=["Etape"]), key="baseleg", use_container_width=True,
    hide_index=True, num_rows="dynamic")

    st.write("#### M√©thodologie")
    st.markdown("Etapes √† suivre par le programme pour d√©terminer la conformit√© √† ce point de contr√¥le.")
    st.markdown("_Double cliquer sur une ligne pour l'√©diter._")
    methodo = st.data_editor(pd.DataFrame(data["methodology"], columns=["Etape"]), key="methodo", use_container_width=True,
    hide_index=True, num_rows="dynamic")

    st.write("#### Exemples")
    
    exconf = st.text_area("Exemple de conformit√©", value=data["conform_example"], placeholder="D√©tail d'un exemple de conformit√© au point de contr√¥le",
            help="Donnez ici le d√©tail d'un exemple de conformit√© au point de contr√¥le")

    exnonconf = st.text_area("Exemple de non conformit√©", value=data["non_conform_example"], placeholder="D√©tail d'un exemple de non-conformit√© au point de contr√¥le",
            help="Donnez ici le d√©tail d'un exemple de non conformit√© au point de contr√¥le")

    st.write("#### Proc√©dure")

    proc = st.text_area("Proc√©dure √† suivre en cas de non-conformit√©",  value=data["proc"], placeholder="Il faut prendre contact avec l‚Äô√©tablissement pour comprendre l‚Äôorigine de l‚Äôindisponibilit√©.",
            help="Proc√©dure √† suivre en cas de non-conformit√©")

    st.markdown('##')
    save = st.button("üíæ Enregistrer", type="primary", use_container_width=True)

    if save:
        data = {
            "category_name": cat["name"],
            "name": name,
            "code": code,
            "desc": desc,
            "base_leg": base_leg.values.ravel().tolist(),
            "methodology": methodo.values.ravel().tolist(),
            "conform_example": exconf,
            "non_conform_example": exnonconf,
            "proc": proc
        }
        with open(f'pdc_content/{cat["code"]}/{code}.json', 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=4)

        st.session_state['state-doccp'] = "enum"
        st.rerun()

def enum():
    import streamlit as st

    st.write("# Documentation points de contr√¥le üìÑ")
    st.sidebar.image("vega.png")

    st.markdown(
        """Ci-dessous sont list√©es les cat√©gories de points de contr√¥le, et dans chacune les points associ√©s."""
    )

    modal = Modal("Cr√©ation d'une cat√©gorie üìö", key="create-category")

    open_modal = st.columns((3,1))[1].button("Ajouter une cat√©gorie", type="primary", use_container_width=True)
    if open_modal:
        modal.open()

    if modal.is_open():
        with modal.container():
            code = st.text_input("Code", placeholder="openfinance",
            help="Code court, sans accents, chiffres ou caract√®res sp√©ciaux, par exemple \"openfinance\" ")

            name = st.text_input("Nom complet", placeholder="Open Finance",
            help="Nom complet, d√©taill√©, par exemple \"Open Finance\" ")

            create = st.button("‚ú® Cr√©er", type="primary")
            if create:
                os.mkdir(f'pdc_content/{code}')
                with open(f'pdc_content/{code}/info.json', 'w', encoding='utf-8') as f:
                    json.dump({"code": code, "name": name}, f, ensure_ascii=False, indent=4)
                modal.close()

    tabs = st.tabs([data["name"] for data in cats])

    controlpointcol = []

    for i, tab in enumerate(tabs):
        code = cats[i]["code"]
        cols = tab.columns((1,1)) 
        create = cols[0].button("‚ûï Ajouter un point de contr√¥le", key=f"addto-cat-{i}", type="secondary", use_container_width=True)
        delete = cols[1].button("üóëÔ∏è Supprimer la cat√©gorie", key=f"delete-cat-{i}", type="primary", use_container_width=True)
        if delete:
            for i in walk[i+1][2]:
                os.remove(f'pdc_content/{code}/{i}')

            os.rmdir(f'pdc_content/{code}')
            st.rerun()
        if create:
            st.session_state['state-doccp-cat-ct'] = cats[i]
            st.session_state['state-doccp'] = "addcp"
            st.rerun()
        
        jsons = [f for f in walk[i+1][2] if f != "info.json"]
        for fname in jsons:
            with open(f'pdc_content/{code}/{fname}') as f:
                dataf = json.load(f)
                controlpointcol.append(dataf)
                colstab = tab.columns((4,1))
                colstab[0].markdown(f"#### {dataf['name']}")
                colstab[0].markdown(f"{dataf['desc']}")
                openbtn = colstab[1].button("Modifier ‚úèÔ∏è", key=f"open-{code}-{fname}")

                if openbtn:
                    st.session_state['state-doccp-cat-ct'] = cats[i]
                    st.session_state['state-doccp-fname'] = dataf['code']
                    st.session_state['state-doccp'] = "editcp"
                    st.rerun()
                tab.markdown("""---""")

    regemb = st.button("üîÑ R√©g√©n√©rer les embeddings des points de contr√¥le üîÑ", use_container_width = True)
    if regemb:
        with st.status("Tritement initial...", expanded=True) as status:
            for cp in controlpointcol:
                st.write(f"Point de contr√¥le {cp['category_name']} > {cp['name']}")
            
            df = pd.DataFrame(np.array(controlpointcol), columns=['content'])

            st.write("Parsing en markdown")
            df['content'] = df['content'].apply(parse_object_to_md)
            st.write("Normalisation")
            df['content'] = df['content'].apply(normalize_text)
            status.update(label="G√©n√©ration des embeddings", state="running", expanded=True)
            st.write("G√©n√©ration des embeddings")
            df['embedding'] = df['content'].apply(generate_embeddings)
            st.write("Enregistrement")
            df.to_json("dump_controlpoint_embeddings.json", orient="records")
            st.write("üéâüéâ Termin√© ! Aper√ßu du tableau avec les embeddings :")
            st.write(df)
            status.update(label="üéâ G√©n√©ration termin√©e !", state="complete", expanded=True)
                

states = {
    "enum": enum,
    "addcp": addcp,
    "editcp": editcp
}

for cat in cats:
    states[f"addcp-{cat['code']}"] = lambda: addcp(cat)

if 'state-doccp' not in st.session_state:
    st.session_state['state-doccp'] = 'enum'

states[st.session_state['state-doccp']]()